<!-- templates/register.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Đăng ký</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height:100vh; display:flex; align-items:center; justify-content:center;
    }
    .card-wrap{ max-width:480px; width:100%; }
    .brand{ font-weight:700; font-size:1.25rem; }
    .is-invalid + .invalid-msg, .error { color:#dc3545; font-size:.85rem; margin-top:.25rem; }
    .btn-primary{ background:#667eea; border:none; }
    .btn-primary:hover{ background:#5563c1; }
  </style>
</head>
<body>

<div class="card card-wrap shadow-lg border-0">
  <div class="card-body p-4">
    <div class="brand text-center mb-3">Tạo tài khoản</div>

    <!-- Alert thành công (nếu có) -->
    <div class="alert alert-success py-2" th:if="${success}" th:text="${success}"></div>

    <form th:action="@{/register}" th:object="${dto}" method="post" id="formRegister" novalidate>

      <!-- Lỗi chung -->
      <div th:if="${#fields.hasGlobalErrors()}" class="alert alert-danger py-2 mb-3">
        <div th:each="e : ${#fields.globalErrors()}" th:text="${e}"></div>
      </div>

      <!-- Username -->
      <div class="mb-3">
        <label for="username" class="form-label">Tên đăng nhập</label>
        <input class="form-control" th:field="*{username}" required minlength="4" maxlength="30" autocomplete="username">
        <div class="error" th:if="${#fields.hasErrors('username')}" th:errors="*{username}"></div>
        <div class="invalid-msg"></div>
      </div>

      <!-- Email -->
      <div class="mb-3">
        <label for="email" class="form-label">Email</label>
        <input class="form-control" th:field="*{email}" type="email" required autocomplete="email">
        <div class="error" th:if="${#fields.hasErrors('email')}" th:errors="*{email}"></div>
        <div class="invalid-msg"></div>
      </div>

      <!-- Password -->
      <div class="mb-3">
        <label for="password" class="form-label">Mật khẩu</label>
        <input class="form-control" th:field="*{password}" type="password" required minlength="6" autocomplete="new-password">
        <div class="error" th:if="${#fields.hasErrors('password')}" th:errors="*{password}"></div>
        <div class="invalid-msg"></div>
      </div>

      <!-- Confirm Password -->
      <div class="mb-2">
        <label for="confirmPassword" class="form-label">Nhập lại mật khẩu</label>
        <input class="form-control" th:field="*{confirmPassword}" type="password" required autocomplete="new-password">
        <div class="error" th:if="${#fields.hasErrors('confirmPassword')}" th:errors="*{confirmPassword}"></div>
        <div class="invalid-msg"></div>
      </div>

      <div class="d-grid mt-3">
        <button type="submit" class="btn btn-primary">Đăng ký</button>
      </div>

      <p class="text-center mt-3 mb-0">
        Đã có tài khoản? <a href="/login" class="link-light text-decoration-underline">Đăng nhập</a>
      </p>
    </form>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  function showError(input, message){
    const msg = input.parentElement.querySelector('.invalid-msg');
    if (message) {
      input.classList.add('is-invalid');
      if (msg) msg.textContent = message;
    } else {
      input.classList.remove('is-invalid');
      if (msg) msg.textContent = '';
    }
  }

  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

  const form = document.getElementById('formRegister');
  const username = document.getElementById('username');
  const email    = document.getElementById('email');
  const password = document.getElementById('password');
  const confirm  = document.getElementById('confirmPassword');

  const validateUsername = (i)=> {
    const v=i.value.trim();
    if(!v) return "Vui lòng nhập tên đăng nhập";
    if(v.length<4) return "Tên đăng nhập tối thiểu 4 ký tự";
    return "";
  };
  const validateEmail = (i)=>{
    const v=i.value.trim();
    if(!v) return "Vui lòng nhập email";
    if(!emailRegex.test(v)) return "Email không hợp lệ";
    return "";
  };
  const validatePassword = (i)=>{
    const v=i.value;
    if(!v) return "Vui lòng nhập mật khẩu";
    if(v.length<6) return "Mật khẩu tối thiểu 6 ký tự";
    return "";
  };
  const validateConfirm = (i,p)=>{
    const v=i.value;
    if(!v) return "Vui lòng nhập lại mật khẩu";
    if(v!==p.value) return "Mật khẩu xác nhận không khớp";
    return "";
  };

  function bind(el, fn){
    el.addEventListener('input', ()=> showError(el, fn(el)));
    el.addEventListener('blur',  ()=> showError(el, fn(el)));
  }

  bind(username, validateUsername);
  bind(email,    validateEmail);
  bind(password, validatePassword);
  bind(confirm,  (i)=> validateConfirm(i, password));

  form.addEventListener('submit', function(e){
    const e1=validateUsername(username);
    const e2=validateEmail(email);
    const e3=validatePassword(password);
    const e4=validateConfirm(confirm, password);
    showError(username,e1); showError(email,e2); showError(password,e3); showError(confirm,e4);
    if(e1||e2||e3||e4) e.preventDefault();
  });
});
</script>

</body>
</html>
